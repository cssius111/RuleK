============================= test session starts ==============================
platform darwin -- Python 3.12.10, pytest-7.4.3, pluggy-1.6.0 -- /Users/chenpinle/anaconda3/envs/playwright_env/bin/python3.12
cachedir: .pytest_cache
rootdir: /Users/chenpinle/Desktop/æ‚/pythonProject/RuleK
configfile: pyproject.toml
plugins: cov-4.1.0, asyncio-0.21.1, playwright-0.7.0, anyio-3.7.1, base-url-2.1.0, mock-3.14.0
asyncio: mode=Mode.AUTO
collecting ... collected 39 items

tests/cli/test_cli_game.py::TestMainMenu::test_new_game_creation_success ğŸ® åˆ›å»ºæ–°æ¸¸æˆ

ä½¿ç”¨é»˜è®¤è®¾ç½®:
- åˆå§‹ææƒ§ç§¯åˆ†: 1000
- NPCæ•°é‡: 4
- éš¾åº¦: normal
[01:57:12] æ–°æ¸¸æˆå¼€å§‹ - ID: game_20250728_015712
[01:57:12] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:12] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:12] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âœ… æ¸¸æˆåˆ›å»ºæˆåŠŸï¼

å·²åˆ›å»º 3 ä¸ªNPC
PASSED
tests/cli/test_cli_game.py::TestMainMenu::test_new_game_cancel ğŸ® åˆ›å»ºæ–°æ¸¸æˆ

ä½¿ç”¨é»˜è®¤è®¾ç½®:
- åˆå§‹ææƒ§ç§¯åˆ†: 1000
- NPCæ•°é‡: 4
- éš¾åº¦: normal
PASSED
tests/cli/test_cli_game.py::TestMainMenu::test_main_menu_exit ============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ® ä¸»èœå•
1. æ–°æ¸¸æˆ
2. åŠ è½½æ¸¸æˆ
3. é€€å‡º
PASSED
tests/cli/test_cli_game.py::TestMainMenu::test_main_menu_invalid_choice ============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ® ä¸»èœå•
1. æ–°æ¸¸æˆ
2. åŠ è½½æ¸¸æˆ
3. é€€å‡º
æ— æ•ˆé€‰æ‹©ï¼
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ® ä¸»èœå•
1. æ–°æ¸¸æˆ
2. åŠ è½½æ¸¸æˆ
3. é€€å‡º
PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_game_status_full [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_game_status_no_state PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_npcs_with_data [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_rules_empty [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_rules_with_data [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestGameStateDisplay::test_print_recent_events [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestSetupPhase::test_setup_phase_view_npcs [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•

ğŸ‘¥ NPCçŠ¶æ€:
------------------------------------------------------------
   åå­—         ä½ç½®        HP     ç†æ™º     ææƒ§      çŠ¶æ€   
------------------------------------------------------------
   å¼ ä¸‰    living_room    99     83     0       å­˜æ´»   
   æå››    living_room    90     92     0       å­˜æ´»   
   ç‹äº”    living_room    92     88     0       å­˜æ´»   
PASSED
tests/cli/test_cli_game.py::TestSetupPhase::test_setup_phase_switch_mode [01:57:13] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:13] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:13] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•

å·²åˆ‡æ¢åˆ°: äº²è‡ªä¸‹åœº æ¨¡å¼
PASSED
tests/cli/test_cli_game.py::TestSetupPhase::test_setup_phase_start_turn [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
[01:57:14] é˜¶æ®µè½¬æ¢: setup â†’ action
[01:57:14] 
==================================================
[01:57:14] ç¬¬ 1 å›åˆ - ä¸‹åˆ ğŸŒ¤ï¸
[01:57:14] å½“å‰ææƒ§ç‚¹æ•°: 1000
PASSED
tests/cli/test_cli_game.py::TestSetupPhase::test_setup_phase_save_game [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
[01:57:14] æ¸¸æˆå·²ä¿å­˜
âœ… æ¸¸æˆå·²ä¿å­˜åˆ°: /private/var/folders/qg/ggt7d3b5509cyb9s5zxvr3lr0000gn/T/pytest-of-chenpinle/pytest-3/test_setup_phase_save_game0/saves/test_save.json
PASSED
tests/cli/test_cli_game.py::TestSetupPhase::test_setup_phase_return_menu [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
PASSED
tests/cli/test_cli_game.py::TestRuleManagement::test_create_custom_rule_placeholder [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestRuleManagement::test_create_rule_from_template_success [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
ğŸ“œ è§„åˆ™ç®¡ç†


ğŸ“œ å½“å‰æ²¡æœ‰æ¿€æ´»çš„è§„åˆ™

1. åˆ›å»ºæ–°è§„åˆ™
2. ä½¿ç”¨æ¨¡æ¿åˆ›å»º
3. å‡çº§è§„åˆ™
4. è¿”å›

å¯ç”¨æ¨¡æ¿:
1. åˆå¤œç…§é•œæ­» - æˆæœ¬: 150
   åœ¨åˆå¤œæ—¶åˆ†ç…§é•œå­ä¼šè¢«é•œä¸­çš„æ¶çµæ‹–å…¥é•œä¸­ä¸–ç•Œ
2. çº¢å­—ç¦å¿Œ - æˆæœ¬: 80
   è¯´å‡ºç‰¹å®šè¯è¯­ä¼šè§¦å‘è¯…å’’
3. ç”µè¯é“ƒå£° - æˆæœ¬: 120
   æ·±å¤œç”µè¯å“èµ·ï¼Œæ¥å¬è€…ä¼šåœ¨ä¸ƒå¤©åæ¶ˆå¤±
4. ç¾¤ä½“å¹»è§‰ - æˆæœ¬: 180
   3äººä»¥ä¸Šåœ¨åŒä¸€æˆ¿é—´æ—¶ä¼šé›†ä½“å‘ç–¯
5. å½±å­æ¨¡ä»¿ - æˆæœ¬: 200
   åšå‡ºç‰¹å®šåŠ¨ä½œåï¼Œå½±å­ä¼šå»¶è¿Ÿæ¨¡ä»¿å¹¶æ”»å‡»
6. æ•²é—¨æ­» - æˆæœ¬: 140
   å¬åˆ°ç‰¹å®šèŠ‚å¥çš„æ•²é—¨å£°åå¼€é—¨ä¼šæ­»äº¡
7. ç‰©å“è¯…å’’ - æˆæœ¬: 100
   æ‹¿èµ·ç‰¹å®šç‰©å“ä¼šè¢«è¯…å’’ç¼ èº«
8. è®°å¿†åˆ é™¤ - æˆæœ¬: 90
   è¿›å…¥ç‰¹å®šæˆ¿é—´ä¼šå¿˜è®°ä¹‹å‰çš„æ‰€æœ‰è§„åˆ™
9. è¿é”ååº” - æˆæœ¬: 220
   ä¸€äººæ­»äº¡ä¼šè§¦å‘åŒæˆ¿é—´å…¶ä»–äººçš„æ­»äº¡å€’è®¡æ—¶
10. æµ´å®¤é™·é˜± - æˆæœ¬: 110
   åœ¨æµ´å®¤å¾…è¶…è¿‡3åˆ†é’Ÿä¼šè¢«å›°ä½
11. å¼€å…³ç¯æ­» - æˆæœ¬: 160
   è¿ç»­3æ¬¡å¼€å…³ç¯ä¼šå¬å”¤é»‘æš—ä¸­çš„ä¸œè¥¿

è§„åˆ™ 'åˆå¤œç…§é•œæ­»' éœ€è¦ 170 ææƒ§ç§¯åˆ†
å½“å‰ç§¯åˆ†: 1000
[01:57:14] è§„åˆ™ [åˆå¤œç…§é•œæ­»] å·²æ·»åŠ åˆ°æ¸¸æˆä¸­
âœ… è§„åˆ™åˆ›å»ºæˆåŠŸï¼
PASSED
tests/cli/test_cli_game.py::TestRuleManagement::test_create_rule_insufficient_points [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestRuleManagement::test_create_rule_invalid_template [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestRuleManagement::test_upgrade_rule_not_implemented [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestActionPhase::test_action_phase_with_npcs [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
[01:57:14] è§„åˆ™ [æµ‹è¯•è§„åˆ™] å·²æ·»åŠ åˆ°æ¸¸æˆä¸­

ğŸ¬ è¡ŒåŠ¨é˜¶æ®µ

NPCè¡ŒåŠ¨ä¸­...
  å¼ ä¸‰ ä» living_room ç§»åŠ¨åˆ° kitchen

âš¡ å¼ ä¸‰ è§¦å‘äº†è§„åˆ™ [æµ‹è¯•è§„åˆ™]!
2025-07-28 01:57:14 | [32mINFO[0m | src.core.rule_executor | ğŸ“ æ‰§è¡Œè§„åˆ™: æµ‹è¯•è§„åˆ™ å¯¹ å¼ ä¸‰
FAILED
tests/cli/test_cli_game.py::TestActionPhase::test_action_phase_no_alive_npcs [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

ğŸ¬ è¡ŒåŠ¨é˜¶æ®µ

NPCè¡ŒåŠ¨ä¸­...

è¡ŒåŠ¨é˜¶æ®µç»“æŸ
[01:57:14] é˜¶æ®µè½¬æ¢: setup â†’ resolution
PASSED
tests/cli/test_cli_game.py::TestActionPhase::test_action_phase_rule_trigger [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestResolutionPhase::test_resolution_phase [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestDialoguePhase::test_dialogue_phase_with_npcs [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestDialoguePhase::test_dialogue_phase_insufficient_npcs [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

ğŸ’¬ å¯¹è¯é˜¶æ®µ
ï¼ˆå¯¹è¯ç”ŸæˆåŠŸèƒ½éœ€è¦æ¥å…¥AIï¼‰
[01:57:14] é˜¶æ®µè½¬æ¢: setup â†’ action
PASSED
tests/cli/test_cli_game.py::TestSaveLoad::test_save_game_success [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
[01:57:14] æ¸¸æˆå·²ä¿å­˜
âœ… æ¸¸æˆå·²ä¿å­˜åˆ°: /private/var/folders/qg/ggt7d3b5509cyb9s5zxvr3lr0000gn/T/pytest-of-chenpinle/pytest-3/test_save_game_success0/saves/test_save.json
PASSED
tests/cli/test_cli_game.py::TestSaveLoad::test_save_game_empty_name [01:57:14] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:14] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:14] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestSaveLoad::test_load_game_success ğŸ“‚ åŠ è½½æ¸¸æˆ

å¯ç”¨å­˜æ¡£:
1. loaded_game
âŒ åŠ è½½å¤±è´¥ï¼šå­˜æ¡£å¯èƒ½å·²æŸå
FAILED
tests/cli/test_cli_game.py::TestSaveLoad::test_load_game_no_saves PASSED
tests/cli/test_cli_game.py::TestSaveLoad::test_load_game_cancel ğŸ“‚ åŠ è½½æ¸¸æˆ

å¯ç”¨å­˜æ¡£:
1. test
PASSED
tests/cli/test_cli_game.py::TestGameOver::test_game_over_display [01:57:16] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:16] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestGameOver::test_game_loop_all_npcs_dead [01:57:16] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:16] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 0 | ç¬¬1å¤© morning
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 1000 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 0
â””â”€ å­˜æ´»NPC: 0/3

============================================================
                          ğŸ’€ æ¸¸æˆç»“æŸ ğŸ’€                          
============================================================

ç»“æŸåŸå› : æ‰€æœ‰NPCéƒ½å·²æ­»äº¡ï¼

æ¸¸æˆç»Ÿè®¡:
- æ€»å›åˆæ•°: 0
- å­˜æ´»å¤©æ•°: 1
- æœ€ç»ˆææƒ§ç§¯åˆ†: 1000
- åˆ›å»ºè§„åˆ™æ•°: 0
PASSED
tests/cli/test_cli_game.py::TestEdgeCasesAndErrors::test_print_rules_with_no_description [01:57:16] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:16] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestEdgeCasesAndErrors::test_switch_mode_toggle [01:57:16] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:16] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:16] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

å·²åˆ‡æ¢åˆ°: äº²è‡ªä¸‹åœº æ¨¡å¼

å·²åˆ‡æ¢åˆ°: å¹•åç®¡ç† æ¨¡å¼
PASSED
tests/cli/test_cli_game.py::TestEdgeCasesAndErrors::test_keyboard_interrupt_handling 

ğŸ‘‹ æ„Ÿè°¢æ¸¸ç©ï¼
PASSED
tests/cli/test_cli_game.py::TestEdgeCasesAndErrors::test_save_game_exception_handling [01:57:18] æ–°æ¸¸æˆå¼€å§‹ - ID: test_game
[01:57:18] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:18] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:18] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ
PASSED
tests/cli/test_cli_game.py::TestEdgeCasesAndErrors::test_load_corrupted_save PASSED
tests/cli/test_cli_game.py::TestIntegration::test_complete_game_flow ============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ® ä¸»èœå•
1. æ–°æ¸¸æˆ
2. åŠ è½½æ¸¸æˆ
3. é€€å‡º
ğŸ® åˆ›å»ºæ–°æ¸¸æˆ

ä½¿ç”¨é»˜è®¤è®¾ç½®:
- åˆå§‹ææƒ§ç§¯åˆ†: 1000
- NPCæ•°é‡: 4
- éš¾åº¦: normal
[01:57:18] æ–°æ¸¸æˆå¼€å§‹ - ID: game_20250728_015718
[01:57:18] NPC [å¼ ä¸‰] åŠ å…¥æ¸¸æˆ
[01:57:18] NPC [æå››] åŠ å…¥æ¸¸æˆ
[01:57:18] NPC [ç‹äº”] åŠ å…¥æ¸¸æˆ

âœ… æ¸¸æˆåˆ›å»ºæˆåŠŸï¼

å·²åˆ›å»º 3 ä¸ªNPC
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 0 | ç¬¬1å¤© morning
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 1000 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 0
â””â”€ å­˜æ´»NPC: 3/3

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
ğŸ“œ è§„åˆ™ç®¡ç†


ğŸ“œ å½“å‰æ²¡æœ‰æ¿€æ´»çš„è§„åˆ™

1. åˆ›å»ºæ–°è§„åˆ™
2. ä½¿ç”¨æ¨¡æ¿åˆ›å»º
3. å‡çº§è§„åˆ™
4. è¿”å›

å¯ç”¨æ¨¡æ¿:
1. åˆå¤œç…§é•œæ­» - æˆæœ¬: 150
   åœ¨åˆå¤œæ—¶åˆ†ç…§é•œå­ä¼šè¢«é•œä¸­çš„æ¶çµæ‹–å…¥é•œä¸­ä¸–ç•Œ
2. çº¢å­—ç¦å¿Œ - æˆæœ¬: 80
   è¯´å‡ºç‰¹å®šè¯è¯­ä¼šè§¦å‘è¯…å’’
3. ç”µè¯é“ƒå£° - æˆæœ¬: 120
   æ·±å¤œç”µè¯å“èµ·ï¼Œæ¥å¬è€…ä¼šåœ¨ä¸ƒå¤©åæ¶ˆå¤±
4. ç¾¤ä½“å¹»è§‰ - æˆæœ¬: 180
   3äººä»¥ä¸Šåœ¨åŒä¸€æˆ¿é—´æ—¶ä¼šé›†ä½“å‘ç–¯
5. å½±å­æ¨¡ä»¿ - æˆæœ¬: 200
   åšå‡ºç‰¹å®šåŠ¨ä½œåï¼Œå½±å­ä¼šå»¶è¿Ÿæ¨¡ä»¿å¹¶æ”»å‡»
6. æ•²é—¨æ­» - æˆæœ¬: 140
   å¬åˆ°ç‰¹å®šèŠ‚å¥çš„æ•²é—¨å£°åå¼€é—¨ä¼šæ­»äº¡
7. ç‰©å“è¯…å’’ - æˆæœ¬: 100
   æ‹¿èµ·ç‰¹å®šç‰©å“ä¼šè¢«è¯…å’’ç¼ èº«
8. è®°å¿†åˆ é™¤ - æˆæœ¬: 90
   è¿›å…¥ç‰¹å®šæˆ¿é—´ä¼šå¿˜è®°ä¹‹å‰çš„æ‰€æœ‰è§„åˆ™
9. è¿é”ååº” - æˆæœ¬: 220
   ä¸€äººæ­»äº¡ä¼šè§¦å‘åŒæˆ¿é—´å…¶ä»–äººçš„æ­»äº¡å€’è®¡æ—¶
10. æµ´å®¤é™·é˜± - æˆæœ¬: 110
   åœ¨æµ´å®¤å¾…è¶…è¿‡3åˆ†é’Ÿä¼šè¢«å›°ä½
11. å¼€å…³ç¯æ­» - æˆæœ¬: 160
   è¿ç»­3æ¬¡å¼€å…³ç¯ä¼šå¬å”¤é»‘æš—ä¸­çš„ä¸œè¥¿

è§„åˆ™ 'åˆå¤œç…§é•œæ­»' éœ€è¦ 170 ææƒ§ç§¯åˆ†
å½“å‰ç§¯åˆ†: 1000
[01:57:18] è§„åˆ™ [åˆå¤œç…§é•œæ­»] å·²æ·»åŠ åˆ°æ¸¸æˆä¸­
âœ… è§„åˆ™åˆ›å»ºæˆåŠŸï¼
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 0 | ç¬¬1å¤© morning
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
[01:57:18] é˜¶æ®µè½¬æ¢: setup â†’ action
[01:57:18] 
==================================================
[01:57:18] ç¬¬ 1 å›åˆ - ä¸‹åˆ ğŸŒ¤ï¸
[01:57:18] å½“å‰ææƒ§ç‚¹æ•°: 830
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 1 | ç¬¬1å¤© afternoon
â”œâ”€ é˜¶æ®µ: action
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

ğŸ¬ è¡ŒåŠ¨é˜¶æ®µ

NPCè¡ŒåŠ¨ä¸­...
  å¼ ä¸‰ ä¸ æå›› äº¤è°ˆ
  æå›› ä» living_room ç§»åŠ¨åˆ° kitchen
  ç‹äº” ä¸ å¼ ä¸‰ äº¤è°ˆ

è¡ŒåŠ¨é˜¶æ®µç»“æŸ
[01:57:18] é˜¶æ®µè½¬æ¢: action â†’ resolution
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 1 | ç¬¬1å¤© afternoon
â”œâ”€ é˜¶æ®µ: resolution
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

ğŸ“Š å›åˆç»“ç®—

æœ¬å›åˆç»Ÿè®¡:
- è§„åˆ™è§¦å‘æ¬¡æ•°: 0
- å­˜æ´»NPC: 3
- å½“å‰ææƒ§ç§¯åˆ†: 830
[01:57:18] é˜¶æ®µè½¬æ¢: resolution â†’ setup
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 1 | ç¬¬1å¤© afternoon
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 1 | ç¬¬1å¤© afternoon
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
ä¿å­˜æ¸¸æˆå¤±è´¥: Object of type datetime is not JSON serializable
âŒ ä¿å­˜æ¸¸æˆå¤±è´¥
============================================================
           ğŸ­ è§„åˆ™æ€ªè°ˆç®¡ç†è€… - Rules of Horror Manager ğŸ­            
============================================================

ğŸ“Š æ¸¸æˆçŠ¶æ€
â”œâ”€ å›åˆ: 1 | ç¬¬1å¤© afternoon
â”œâ”€ é˜¶æ®µ: setup
â”œâ”€ æ¨¡å¼: å¹•åç®¡ç†
â”œâ”€ ææƒ§ç§¯åˆ†: 830 ğŸ’€
â”œâ”€ æ´»è·ƒè§„åˆ™: 1
â””â”€ å­˜æ´»NPC: 3/3

âš™ï¸  å‡†å¤‡é˜¶æ®µ
1. åˆ›å»º/ç®¡ç†è§„åˆ™
2. æŸ¥çœ‹NPCçŠ¶æ€
3. åˆ‡æ¢æ§åˆ¶æ¨¡å¼
4. å¼€å§‹å›åˆ
5. ä¿å­˜æ¸¸æˆ
6. è¿”å›ä¸»èœå•
FAILED

=================================== FAILURES ===================================
_________________ TestActionPhase.test_action_phase_with_npcs __________________

self = <cli.test_cli_game.TestActionPhase object at 0x1038f2210>
initialized_game = <src.cli_game.CLIGame object at 0x103a55310>
mock_input_sequence = <cli.conftest.mock_input_sequence.<locals>.InputSequence object at 0x103a55be0>

    @pytest.mark.asyncio
    async def test_action_phase_with_npcs(self, initialized_game, mock_input_sequence):
        """æµ‹è¯•NPCè¡ŒåŠ¨é˜¶æ®µ - éªŒè¯NPCè¡ŒåŠ¨å’Œè§„åˆ™è§¦å‘"""
        mock_input_sequence.add("")  # æŒ‰å›è½¦ç»§ç»­
    
        # æ·»åŠ ä¸€ä¸ªè§„åˆ™
        rule = Rule(
            id="test_rule",
            name="æµ‹è¯•è§„åˆ™",
            trigger=TriggerCondition(action="move", probability=1.0),
            effect=RuleEffect(type=EffectType.FEAR_GAIN, fear_gain=10)
        )
        initialized_game.game_manager.add_rule(rule)
    
        with patch('asyncio.sleep', new_callable=AsyncMock):
>           await initialized_game.action_phase()

tests/cli/test_cli_game.py:302: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.cli_game.CLIGame object at 0x103a55310>

    async def action_phase(self):
        """è¡ŒåŠ¨é˜¶æ®µ"""
        print("\nğŸ¬ è¡ŒåŠ¨é˜¶æ®µ")
    
        # NPCè‡ªåŠ¨è¡ŒåŠ¨
        print("\nNPCè¡ŒåŠ¨ä¸­...")
    
        for npc_id, npc in self.game_manager.state.npcs.items():
            if not npc.get("alive", True):
                continue
    
            # å†³å®šè¡ŒåŠ¨
            decision = self.npc_behavior.decide_action(npc)
    
            # æ‰§è¡Œè¡ŒåŠ¨
            result = self.npc_behavior.execute_action(npc, decision)
    
            # æ˜¾ç¤ºè¡ŒåŠ¨
            for msg in result["messages"]:
                print(f"  {msg}")
    
            # åˆ›å»ºè§„åˆ™ä¸Šä¸‹æ–‡
            context = RuleContext(
                actor=npc,
                action=decision.action.value,
                game_state=self.game_manager.state.to_dict()
            )
    
            # æ£€æŸ¥æ˜¯å¦è§¦å‘è§„åˆ™
            triggered_rules = self.rule_executor.check_all_rules(context)
    
            for rule, probability in triggered_rules:
                import random
                if random.random() < probability:
                    print(f"\nâš¡ {npc['name']} è§¦å‘äº†è§„åˆ™ [{rule.name}]!")
>                   exec_result = self.rule_executor.execute_rule(rule, context)

src/cli_game.py:325: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.core.rule_executor.RuleExecutor object at 0x103a55820>
rule = Rule(id='test_rule', name='æµ‹è¯•è§„åˆ™', description='', level=1, creator='system', created_at=datetime.datetime(2025, 7, 28,...table=True, reverse_risk=0.1, active=True, cooldown_turns=0, times_triggered=1, times_discovered=0, upgrade_options=[])
context = <src.core.rule_executor.RuleContext object at 0x103a54da0>

    def execute_rule(self, rule: Rule, context: RuleContext) -> Dict[str, Any]:
        """æ‰§è¡Œè§„åˆ™æ•ˆæœ"""
        logger.info(f"æ‰§è¡Œè§„åˆ™: {rule.name} å¯¹ {context.actor_name}")
    
        # åº”ç”¨è§„åˆ™æ•ˆæœ
        result = rule.apply_effect(context.actor)
    
        # æ›´æ–°æ¸¸æˆçŠ¶æ€
>       self._apply_rule_effects(rule, context, result)

src/core/rule_executor.py:246: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <src.core.rule_executor.RuleExecutor object at 0x103a55820>
rule = Rule(id='test_rule', name='æµ‹è¯•è§„åˆ™', description='', level=1, creator='system', created_at=datetime.datetime(2025, 7, 28,...table=True, reverse_risk=0.1, active=True, cooldown_turns=0, times_triggered=1, times_discovered=0, upgrade_options=[])
context = <src.core.rule_executor.RuleContext object at 0x103a54da0>
result = {'effect_type': <EffectType.FEAR_GAIN: 'fear_gain'>, 'fear_gained': 10, 'messages': [], 'success': True}

    def _apply_rule_effects(self, rule: Rule, context: RuleContext, result: Dict):
        """åº”ç”¨è§„åˆ™æ•ˆæœåˆ°æ¸¸æˆçŠ¶æ€"""
        # è·å¾—ææƒ§ç§¯åˆ†
        if result.get("fear_gained", 0) > 0:
>           self.game_manager.gain_fear_points(
                result["fear_gained"],
                f"è§„åˆ™è§¦å‘: {rule.name}"
            )
E           AttributeError: 'GameStateManager' object has no attribute 'gain_fear_points'. Did you mean: 'add_fear_points'?

src/core/rule_executor.py:276: AttributeError
------------------------------ Captured log call -------------------------------
INFO     src.core.rule_executor:rule_executor.py:240 ğŸ“ æ‰§è¡Œè§„åˆ™: æµ‹è¯•è§„åˆ™ å¯¹ å¼ ä¸‰
_____________________ TestSaveLoad.test_load_game_success ______________________

self = <cli.test_cli_game.TestSaveLoad object at 0x1038f0260>
cli_game = <src.cli_game.CLIGame object at 0x1039fa3c0>
mock_input_sequence = <cli.conftest.mock_input_sequence.<locals>.InputSequence object at 0x1039fa6c0>
temp_save_dir = PosixPath('/private/var/folders/qg/ggt7d3b5509cyb9s5zxvr3lr0000gn/T/pytest-of-chenpinle/pytest-3/test_load_game_success0/saves')

    @pytest.mark.asyncio
    async def test_load_game_success(self, cli_game, mock_input_sequence, temp_save_dir):
        """æµ‹è¯•æˆåŠŸåŠ è½½æ¸¸æˆ - éªŒè¯çŠ¶æ€æ¢å¤"""
        # åˆ›å»ºæµ‹è¯•å­˜æ¡£
        save_data = {
            "state": {
                "game_id": "loaded_game",
                "started_at": "2024-01-01T00:00:00",
                "current_turn": 10,
                "fear_points": 500,
                "phase": "setup",
                "time_of_day": "evening",
                "mode": "backstage",
                "total_fear_gained": 500,
                "npcs_died": 2,
                "rules_triggered": 15,
                "difficulty": "hard",
                "day": 3,
                "npcs": {},
                "active_rules": ["rule_001"],
                "events_history": []
            },
            "rules": [],
            "npcs": [],
            "spirits": [],
            "game_log": ["æ¸¸æˆå¼€å§‹"]
        }
    
        save_file = temp_save_dir / "loaded_game.json"
        with open(save_file, "w") as f:
            json.dump(save_data, f)
    
        cli_game.game_manager.save_dir = temp_save_dir
        mock_input_sequence.add("1", "6")  # é€‰æ‹©ç¬¬ä¸€ä¸ªå­˜æ¡£ï¼Œç„¶åé€€å‡º
    
        with patch.object(cli_game, 'game_loop', new_callable=AsyncMock):
            await cli_game.load_game_menu()
    
>       assert cli_game.game_manager.state is not None
E       assert None is not None
E        +  where None = <src.core.game_state.GameStateManager object at 0x1039fa210>.state
E        +    where <src.core.game_state.GameStateManager object at 0x1039fa210> = <src.cli_game.CLIGame object at 0x1039fa3c0>.game_manager

tests/cli/test_cli_game.py:467: AssertionError
___________________ TestIntegration.test_complete_game_flow ____________________

self = <cli.test_cli_game.TestIntegration object at 0x103918a10>
cli_game = <src.cli_game.CLIGame object at 0x1024928d0>
mock_input_sequence = <cli.conftest.mock_input_sequence.<locals>.InputSequence object at 0x1040e86b0>
temp_save_dir = PosixPath('/private/var/folders/qg/ggt7d3b5509cyb9s5zxvr3lr0000gn/T/pytest-of-chenpinle/pytest-3/test_complete_game_flow0/saves')

    @pytest.mark.asyncio
    async def test_complete_game_flow(self, cli_game, mock_input_sequence, temp_save_dir):
        """æµ‹è¯•å®Œæ•´æ¸¸æˆæµç¨‹ - æ–°å»º/è§„åˆ™/å›åˆ/ä¿å­˜/åŠ è½½"""
        cli_game.game_manager.save_dir = temp_save_dir
    
        # å®Œæ•´æµç¨‹è¾“å…¥åºåˆ—
        mock_input_sequence.add(
            "1",        # ä¸»èœå• - æ–°æ¸¸æˆ
            "y",        # ç¡®è®¤åˆ›å»º
            "1",        # å‡†å¤‡é˜¶æ®µ - åˆ›å»ºè§„åˆ™
            "2",        # è§„åˆ™ç®¡ç† - ä½¿ç”¨æ¨¡æ¿
            "1",        # é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡æ¿
            "y",        # ç¡®è®¤åˆ›å»º
            "4",        # è¿”å›è§„åˆ™ç®¡ç†
            "4",        # å‡†å¤‡é˜¶æ®µ - å¼€å§‹å›åˆ
            "",         # è¡ŒåŠ¨é˜¶æ®µ - æŒ‰å›è½¦
            "",         # ç»“ç®—é˜¶æ®µ - æŒ‰å›è½¦
            "5",        # å‡†å¤‡é˜¶æ®µ - ä¿å­˜æ¸¸æˆ
            "integration_test",  # å­˜æ¡£å
            "",         # æŒ‰å›è½¦ç»§ç»­
            "6"         # è¿”å›ä¸»èœå•
        )
    
        with patch('asyncio.sleep', new_callable=AsyncMock):
            await cli_game.run()
    
        # éªŒè¯å­˜æ¡£åˆ›å»º
        save_file = temp_save_dir / "integration_test.json"
        assert save_file.exists()
    
        # éªŒè¯æ¸¸æˆçŠ¶æ€
        with open(save_file) as f:
>           data = json.load(f)

tests/cli/test_cli_game.py:642: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

fp = <_io.TextIOWrapper name='/private/var/folders/qg/ggt7d3b5509cyb9s5zxvr3lr0000gn/T/pytest-of-chenpinle/pytest-3/test_complete_game_flow0/saves/integration_test.json' mode='r' encoding='UTF-8'>
cls = None, object_hook = None, parse_float = None, parse_int = None
parse_constant = None, object_pairs_hook = None, kw = {}

    def load(fp, *, cls=None, object_hook=None, parse_float=None,
            parse_int=None, parse_constant=None, object_pairs_hook=None, **kw):
        """Deserialize ``fp`` (a ``.read()``-supporting file-like object containing
        a JSON document) to a Python object.
    
        ``object_hook`` is an optional function that will be called with the
        result of any object literal decode (a ``dict``). The return value of
        ``object_hook`` will be used instead of the ``dict``. This feature
        can be used to implement custom decoders (e.g. JSON-RPC class hinting).
    
        ``object_pairs_hook`` is an optional function that will be called with the
        result of any object literal decoded with an ordered list of pairs.  The
        return value of ``object_pairs_hook`` will be used instead of the ``dict``.
        This feature can be used to implement custom decoders.  If ``object_hook``
        is also defined, the ``object_pairs_hook`` takes priority.
    
        To use a custom ``JSONDecoder`` subclass, specify it with the ``cls``
        kwarg; otherwise ``JSONDecoder`` is used.
        """
>       return loads(fp.read(),
            cls=cls, object_hook=object_hook,
            parse_float=parse_float, parse_int=parse_int,
            parse_constant=parse_constant, object_pairs_hook=object_pairs_hook, **kw)

../../../../anaconda3/envs/playwright_env/lib/python3.12/json/__init__.py:293: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

s = '{\n  "state": {\n    "game_id": "game_20250728_015718",\n    "started_at": "2025-07-28T01:57:18.553669",\n    "curren...",\n      "description": "åœ¨åˆå¤œæ—¶åˆ†ç…§é•œå­ä¼šè¢«é•œä¸­çš„æ¶çµæ‹–å…¥é•œä¸­ä¸–ç•Œ",\n      "level": 1,\n      "creator": "system",\n      "created_at": '
cls = None, object_hook = None, parse_float = None, parse_int = None
parse_constant = None, object_pairs_hook = None, kw = {}

    def loads(s, *, cls=None, object_hook=None, parse_float=None,
            parse_int=None, parse_constant=None, object_pairs_hook=None, **kw):
        """Deserialize ``s`` (a ``str``, ``bytes`` or ``bytearray`` instance
        containing a JSON document) to a Python object.
    
        ``object_hook`` is an optional function that will be called with the
        result of any object literal decode (a ``dict``). The return value of
        ``object_hook`` will be used instead of the ``dict``. This feature
        can be used to implement custom decoders (e.g. JSON-RPC class hinting).
    
        ``object_pairs_hook`` is an optional function that will be called with the
        result of any object literal decoded with an ordered list of pairs.  The
        return value of ``object_pairs_hook`` will be used instead of the ``dict``.
        This feature can be used to implement custom decoders.  If ``object_hook``
        is also defined, the ``object_pairs_hook`` takes priority.
    
        ``parse_float``, if specified, will be called with the string
        of every JSON float to be decoded. By default this is equivalent to
        float(num_str). This can be used to use another datatype or parser
        for JSON floats (e.g. decimal.Decimal).
    
        ``parse_int``, if specified, will be called with the string
        of every JSON int to be decoded. By default this is equivalent to
        int(num_str). This can be used to use another datatype or parser
        for JSON integers (e.g. float).
    
        ``parse_constant``, if specified, will be called with one of the
        following strings: -Infinity, Infinity, NaN.
        This can be used to raise an exception if invalid JSON numbers
        are encountered.
    
        To use a custom ``JSONDecoder`` subclass, specify it with the ``cls``
        kwarg; otherwise ``JSONDecoder`` is used.
        """
        if isinstance(s, str):
            if s.startswith('\ufeff'):
                raise JSONDecodeError("Unexpected UTF-8 BOM (decode using utf-8-sig)",
                                      s, 0)
        else:
            if not isinstance(s, (bytes, bytearray)):
                raise TypeError(f'the JSON object must be str, bytes or bytearray, '
                                f'not {s.__class__.__name__}')
            s = s.decode(detect_encoding(s), 'surrogatepass')
    
        if (cls is None and object_hook is None and
                parse_int is None and parse_float is None and
                parse_constant is None and object_pairs_hook is None and not kw):
>           return _default_decoder.decode(s)

../../../../anaconda3/envs/playwright_env/lib/python3.12/json/__init__.py:346: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x101d41790>
s = '{\n  "state": {\n    "game_id": "game_20250728_015718",\n    "started_at": "2025-07-28T01:57:18.553669",\n    "curren...",\n      "description": "åœ¨åˆå¤œæ—¶åˆ†ç…§é•œå­ä¼šè¢«é•œä¸­çš„æ¶çµæ‹–å…¥é•œä¸­ä¸–ç•Œ",\n      "level": 1,\n      "creator": "system",\n      "created_at": '
_w = <built-in method match of re.Pattern object at 0x101f8ef60>

    def decode(self, s, _w=WHITESPACE.match):
        """Return the Python representation of ``s`` (a ``str`` instance
        containing a JSON document).
    
        """
>       obj, end = self.raw_decode(s, idx=_w(s, 0).end())

../../../../anaconda3/envs/playwright_env/lib/python3.12/json/decoder.py:338: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <json.decoder.JSONDecoder object at 0x101d41790>
s = '{\n  "state": {\n    "game_id": "game_20250728_015718",\n    "started_at": "2025-07-28T01:57:18.553669",\n    "curren...",\n      "description": "åœ¨åˆå¤œæ—¶åˆ†ç…§é•œå­ä¼šè¢«é•œä¸­çš„æ¶çµæ‹–å…¥é•œä¸­ä¸–ç•Œ",\n      "level": 1,\n      "creator": "system",\n      "created_at": '
idx = 0

    def raw_decode(self, s, idx=0):
        """Decode a JSON document from ``s`` (a ``str`` beginning with
        a JSON document) and return a 2-tuple of the Python
        representation and the index in ``s`` where the document ended.
    
        This can be used to decode a JSON document from a string that may
        have extraneous data at the end.
    
        """
        try:
            obj, end = self.scan_once(s, idx)
        except StopIteration as err:
>           raise JSONDecodeError("Expecting value", s, err.value) from None
E           json.decoder.JSONDecodeError: Expecting value: line 129 column 21 (char 3046)

../../../../anaconda3/envs/playwright_env/lib/python3.12/json/decoder.py:356: JSONDecodeError
=============================== warnings summary ===============================
../../../../anaconda3/envs/playwright_env/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252
  /Users/chenpinle/anaconda3/envs/playwright_env/lib/python3.12/site-packages/pydantic/_internal/_generate_schema.py:252: PydanticDeprecatedSince20: `json_encoders` is deprecated. See https://docs.pydantic.dev/2.5/concepts/serialization/#custom-serializers for alternatives. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(

../../../../anaconda3/envs/playwright_env/lib/python3.12/site-packages/pydantic/_internal/_config.py:268
  /Users/chenpinle/anaconda3/envs/playwright_env/lib/python3.12/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/cli/test_cli_game.py: 36 warnings
  /Users/chenpinle/Desktop/æ‚/pythonProject/RuleK/src/core/game_state.py:160: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    result[key] = value.dict()

tests/cli/test_cli_game.py: 37 warnings
  /Users/chenpinle/anaconda3/envs/playwright_env/lib/python3.12/site-packages/pydantic/main.py:979: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn('The `dict` method is deprecated; use `model_dump` instead.', DeprecationWarning)

tests/cli/test_cli_game.py::TestIntegration::test_complete_game_flow
  /Users/chenpinle/Desktop/æ‚/pythonProject/RuleK/src/core/game_state.py:239: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    "rules": [r.dict() if hasattr(r, 'dict') else r for r in self.rules],

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/cli/test_cli_game.py::TestActionPhase::test_action_phase_with_npcs
FAILED tests/cli/test_cli_game.py::TestSaveLoad::test_load_game_success - ass...
FAILED tests/cli/test_cli_game.py::TestIntegration::test_complete_game_flow
================== 3 failed, 36 passed, 76 warnings in 6.25s ===================
