# AI集成实施计划

## 概述

本文档详细规划了RuleK项目中DeepSeek AI能力的集成方案，包括群体对话生成、任务分配、叙事生成和规则评估等核心功能的实现。

### 目标

1. **群体对话系统**：生成NPC之间的真实对话，反映其性格和当前状态
2. **智能任务分配**：基于NPC性格和状态的行动规划
3. **叙事生成**：将游戏事件转化为恐怖小说风格的叙述
4. **规则自然语言处理**：将玩家的自然语言规则转化为结构化数据

## 技术架构

```
┌─────────────────────────────────────────────────┐
│                  Game Manager                    │
├─────────────────────────────────────────────────┤
│              AI Pipeline Layer                   │
│  ┌───────────┐  ┌────────────┐  ┌───────────┐  │
│  │Turn Plan  │  │ Narrative  │  │Rule Eval  │  │
│  │Generator  │  │ Generator  │  │ Engine    │  │
│  └───────────┘  └────────────┘  └───────────┘  │
├─────────────────────────────────────────────────┤
│              DeepSeek Client                     │
│         (API调用、重试、缓存、降级)              │
├─────────────────────────────────────────────────┤
│           Pydantic Schemas                       │
│    (数据验证、类型安全、结构化输出)              │
└─────────────────────────────────────────────────┘
```

## 实施阶段

### 第一阶段：基础架构搭建（2天）

#### 1.1 Schema定义
- [ ] 创建 `src/api/schemas.py`
  - DialogueTurn：对话回合
  - PlannedAction：计划行动
  - TurnPlan：回合计划
  - NarrativeOut：叙事输出
  - RuleEvalResult：规则评估结果

#### 1.2 DeepSeek客户端
- [ ] 创建 `src/api/deepseek_client.py`
  - 基础请求方法 `_make_request`
  - 错误处理和重试机制
  - 响应解析和验证

#### 1.3 Prompt管理
- [ ] 创建 `src/api/prompts.py`
  - 使用Jinja2模板管理prompt
  - 支持动态参数注入

### 第二阶段：核心功能实现（3天）

#### 2.1 群体对话与任务分配
```python
async def generate_turn_plan(
    self,
    npc_states: List[Dict[str, Any]],
    scene_context: Dict[str, Any],
    available_places: List[str],
    time_of_day: str,
    min_dialogue: int = 1
) -> TurnPlan
```

**实现要点**：
- NPC状态格式化（名字、恐惧值、理智值、性格特征、当前状态）
- 场景上下文构建（时间、地点、最近事件）
- JSON响应解析和Schema验证
- 失败降级策略

#### 2.2 叙事生成
```python
async def generate_narrative_text(
    self,
    events: List[Dict[str, Any]],
    time_of_day: str,
    min_len: int = 200
) -> str
```

**实现要点**：
- 事件列表格式化
- 叙事风格控制（恐怖/悬疑）
- 长度验证（200-300字）
- 连贯性检查

#### 2.3 规则自然语言处理
```python
async def evaluate_rule_nl(
    self, 
    rule_nl: str, 
    world_ctx: Dict[str, Any]
) -> RuleEvalResult
```

**实现要点**：
- 规则解析为触发器和效果
- 成本估算（50-500积分）
- 难度评估（1-10级）
- 漏洞识别和改进建议

### 第三阶段：系统集成（2天）

#### 3.1 管线整合
- [ ] 创建 `src/ai/turn_pipeline.py`
  - `run_turn_ai`：执行AI驱动的回合
  - 对话记录集成
  - 行动验证和执行

#### 3.2 游戏管理器适配
- [ ] 修改 `GameStateManager`
  - 添加AI相关配置开关
  - 集成AI管线调用点
  - 实现降级fallback机制

#### 3.3 CLI集成
- [ ] 更新CLI命令
  - setup_phase中的AI对话触发
  - resolution_phase中的叙事生成
  - 规则创建的自然语言支持

### 第四阶段：优化与测试（2天）

#### 4.1 性能优化
- [ ] 实现响应缓存机制
- [ ] 并发请求优化
- [ ] Token使用优化

#### 4.2 测试覆盖
- [ ] 单元测试
  - Schema验证测试
  - Prompt构建测试
  - 响应解析测试
- [ ] 集成测试
  - 完整回合流程测试
  - 错误处理测试
  - 降级机制测试

## 详细技术规范

### Prompt模板规范

#### 群体对话模板
```
System: 恐怖生存游戏导演，生成NPC对话和行动计划
User: 
- 场景信息（时间、地点、事件）
- NPC状态列表
- 可用地点
- 输出JSON Schema
```

#### 叙事生成模板
```
System: 恐怖小说叙述者，200-300字第三人称叙事
User:
- 时间段
- 事件列表
- 纯文本输出要求
```

#### 规则评估模板
```
System: 规则评估官，解析自然语言为结构化规则
User:
- 玩家规则描述
- 游戏状态摘要
- JSON Schema要求
```

### 错误处理策略

1. **网络错误**：指数退避重试（最多3次）
2. **解析错误**：降级到简化prompt重试
3. **验证错误**：使用默认值填充
4. **超时**：30秒超时，降级到本地逻辑

### 配置参数

```python
AI_CONFIG = {
    "enabled": True,
    "timeout": 30,
    "max_retries": 3,
    "cache_ttl": 300,
    "model": "deepseek-chat",
    "temperature": 0.8,
    "max_tokens": 1000
}
```

## 测试计划

### 单元测试

1. **Schema测试**
   - 各种输入的验证
   - 边界值测试
   - 错误输入处理

2. **Client测试**
   - Mock API响应
   - 重试机制测试
   - 超时处理测试

### 集成测试

1. **回合流程测试**
   - 完整的对话生成和执行
   - 多NPC交互场景
   - 异常状态处理

2. **叙事生成测试**
   - 不同事件类型的叙述
   - 长度和风格验证
   - 连贯性检查

### 压力测试

- 并发请求处理
- 长时间运行稳定性
- 内存使用监控

## 风险和缓解措施

### 技术风险

1. **API限流**
   - 缓解：实现请求队列和缓存
   
2. **响应不稳定**
   - 缓解：多级降级策略

3. **成本控制**
   - 缓解：Token使用监控和预算限制

### 业务风险

1. **内容生成质量**
   - 缓解：Prompt优化和后处理

2. **响应延迟**
   - 缓解：异步处理和预生成

## 实施时间表

| 阶段 | 任务 | 工时 | 负责人 |
|------|------|------|--------|
| 第一阶段 | 基础架构 | 2天 | 开发团队 |
| 第二阶段 | 核心功能 | 3天 | 开发团队 |
| 第三阶段 | 系统集成 | 2天 | 开发团队 |
| 第四阶段 | 测试优化 | 2天 | QA团队 |
| **总计** | | **9天** | |

## 验收标准

1. **功能完整性**
   - 所有AI功能正常工作
   - 降级机制生效
   - 错误处理完善

2. **性能指标**
   - 平均响应时间 < 3秒
   - 成功率 > 95%
   - 无内存泄漏

3. **用户体验**
   - 对话自然流畅
   - 叙事风格统一
   - 规则解析准确

## 后续优化方向

1. **模型微调**：基于游戏数据微调专属模型
2. **多模型支持**：支持切换不同AI模型
3. **实时学习**：根据玩家反馈优化生成质量
4. **内容过滤**：确保生成内容符合游戏氛围

---

*文档版本：1.0*  
*最后更新：2024-12-20*  
*作者：RuleK开发团队*
