# 🐛 Bug修复记录

## 修复日期：2024-12-22

### 问题1：硬编码的测试NPC
**症状：** 
- 创建4个NPC时，实际显示7个NPC
- 其中包含硬编码的"张三"、"李四"、"王五"

**根因：**
- `src/core/game_state.py` 的 `GameStateManager.new_game()` 方法会自动调用 `_create_default_npcs()`
- 该方法会创建3个硬编码的中文名字NPC用于测试

**修复：**
1. 移除 `game_state.py` 中的自动创建默认NPC的代码
2. 改进 `npc_manager.py` 使用英文名字池，并支持随机选择
3. 更新 `game_service.py` 让NPCManager自动选择名字，而不是使用"NPC_1"格式

### 问题2：NPC名字不够灵活
**症状：**
- NPC名字要么是"NPC_1"格式，要么是硬编码的中文名

**修复：**
1. 更新 `npc.py` 的名字池，使用更适合恐怖游戏氛围的英文名字
2. 增加带职业的角色名（如 Dr. Harrison, Officer Miller）
3. 背景描述改为英文，更有国际化感觉

### 问题3：测试失败问题
**症状：**
移除默认NPC创建后，多个测试失败：
- `test_new_game_creation_success` - 断言NPC数量 > 0 失败
- `test_action_phase_rule_trigger` - 断言内容包含特定文本失败
- `test_dialogue_phase_with_npcs` - 断言对话阶段文本失败
- `test_game_state_manager` - 断言NPC数量 > 0 失败
- `test_npc_behavior` - 索引错误（没有NPC）
- `test_rule_executor` - 索引错误（没有NPC）

**修复：**
1. 在 `GameStateManager.new_game()` 中添加测试模式支持
   - 当 `config["create_test_npcs"] = True` 时创建NPC
   - 添加 `_create_test_npcs()` 方法用于测试

2. 更新测试fixtures
   - `tests/cli/conftest.py` 中的 `initialized_game` 启用测试NPC创建
   - 单元测试中添加 `create_test_npcs` 配置

3. 在 `CLIGame.new_game()` 中添加测试模式检测
   - 当 `PYTEST_RUNNING=1` 时自动创建测试NPC

4. 添加缺失的工具方法
   - `add_npc()` - 添加NPC到游戏状态
   - `add_rule()` - 添加规则
   - `get_alive_npcs()` - 获取存活的NPC
   - `get_active_npcs()` - 获取活跃的NPC
   - `spend_fear_points()` - 消耗恐惧积分
   - `create_rule()` - 创建规则

## 影响的文件
- `src/core/game_state.py` - 添加测试NPC创建和工具方法
- `src/models/npc_manager.py` - 改进名字选择逻辑  
- `src/models/npc.py` - 更新名字池和背景模板
- `web/backend/services/game_service.py` - 自动名字生成
- `src/cli_game.py` - 添加测试模式支持
- `tests/cli/conftest.py` - 更新fixtures以创建测试NPC
- `tests/unit/test_core.py` - 更新测试以使用测试NPC

## 测试方法

### 快速验证
```bash
# 验证NPC创建
python scripts/test/test_npc_creation.py

# 验证修复效果
python scripts/test/test_quick_fixes.py

# 验证失败的测试
python scripts/test/verify_test_fixes.py
```

### 完整测试
```bash
# 运行所有测试
pytest tests/

# 运行特定测试
pytest tests/cli/test_cli_game.py::TestMainMenu::test_new_game_creation_success -v
pytest tests/unit/test_core.py::test_game_state_manager -v
```

## 后续建议
1. 考虑从配置文件或数据库加载 NPC名字池
2. 实现更智能的名字生成（如根据背景生成相应的名字）
3. 添加名字去重功能，避免同一游戏中出现重复名字
4. 调查并修复Create Rule按钮的显示问题
5. 考虑将测试数据和正式游戏数据完全分离

## 注意事项
- 正常游戏模式下不会自动创建NPC
- 只有在测试模式或明确配置时才会创建测试NPC
- Web服务依然通过`game_service._create_npcs()`正常创建NPC

---
*记录人：AI Assistant*
*审核状态：已验证*
*更新时间：2024-12-22*
