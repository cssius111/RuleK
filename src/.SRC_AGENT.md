# 🎮 源代码Agent - 核心代码规则

## 继承主Agent规则
必须先读取 `/MAIN_AGENT.md`

## 源代码特定规则

### 目录结构
```
src/
├── core/           # 游戏核心逻辑
│   ├── game_engine.py
│   ├── game_state.py
│   └── rules.py
├── ai/             # AI集成
│   ├── deepseek_client.py
│   └── turn_pipeline.py
├── api/            # API接口
│   ├── schemas.py
│   └── prompts.py
├── models/         # 数据模型
├── managers/       # 管理器
└── utils/          # 工具函数
```

### 核心代码操作规则

#### 1. 修改核心模块
```python
# ✅ 正确 - 谨慎修改
1. 备份: read_file("src/core/game_engine.py")
2. 测试: 确保有对应测试
3. 修改: edit_file("src/core/game_engine.py", minimal_changes)

# ❌ 错误
- 创建 game_engine_new.py
- 大规模重写（应该渐进式重构）
```

#### 2. 模块职责划分
```python
# core/ - 纯游戏逻辑，不依赖外部
class GameEngine:     # 游戏引擎
class GameState:      # 游戏状态
class Rule:          # 规则系统

# ai/ - AI相关，可选功能
class AIClient:      # AI客户端
class TurnPipeline:  # 回合处理

# api/ - 对外接口
class GameSchema:    # 数据模式
class Prompts:       # AI提示词
```

#### 3. 依赖原则
```python
# ✅ 正确依赖方向
api -> ai -> core
web -> api -> core

# ❌ 错误依赖
core -> web  # 核心不依赖Web
core -> ai   # 核心不依赖AI
```

### 代码规范

#### 命名规范
```python
# 类名：PascalCase
class GameEngine:
class RuleManager:

# 函数名：snake_case
def create_rule():
def validate_action():

# 常量：UPPER_CASE
MAX_PLAYERS = 10
DEFAULT_FEAR = 50

# 私有成员：前缀下划线
def _internal_method():
self._private_var = None
```

#### 类型注解
```python
# ✅ 使用类型注解
def create_rule(content: str, rule_type: RuleType) -> Rule:
    pass

# ❌ 不要省略类型
def create_rule(content, rule_type):  # 缺少类型
    pass
```

### 禁止操作
- ❌ 创建 `game2.py`（修改原文件）
- ❌ 创建 `core_enhanced/`（修改原目录）
- ❌ 循环依赖（保持单向依赖）
- ❌ 在core中导入web模块